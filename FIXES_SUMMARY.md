# ๐ง ููุฎุต ุงูุฅุตูุงุญุงุช - Database & Permissions

## โ **ุงููุดุงูู ุงูุชู ุชู ุงูุชุดุงููุง:**

### 1๏ธโฃ **Database Connection Error**
```
Error: Connection terminated unexpectedly
at /opt/render/project/src/node_modules/pg-pool/index.js:45:11
```

**ุงูุณุจุจ:**
- ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููุทุน ุจุนุฏ ูุชุฑุฉ ูู ุนุฏู ุงููุดุงุท
- Render ูููู ุงูุงุชุตุงูุงุช ุงูุฎุงููุฉ
- ูุง ุชูุฌุฏ ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ

**ุงูุชุฃุซูุฑ:**
- โ ูุดู ุชุณุฌูู ุงูุฏุฎูู
- โ ูุดู ุฌููุน API calls
- โ `{"error":"ุฎุทุฃ ุฏุงุฎูู ูู ุงูุฎุงุฏู"}`

---

### 2๏ธโฃ **Camera Permission Crash**
```
This app has crashed because it attempted to access privacy-sensitive 
data without a usage description. The app's Info.plist must contain an 
NSCameraUsageDescription key
```

**ุงูุณุจุจ:**
- iOS ูุชุทูุจ `NSCameraUsageDescription` ูู `Info.plist`
- ุงูุชุทุจูู ุญุงูู ูุชุญ ุงููุงููุฑุง ุจุฏูู ุตูุงุญูุฉ
- ุนุฏู ูุฌูุฏ `NSPhotoLibraryUsageDescription`

**ุงูุชุฃุซูุฑ:**
- โ Crash ููุฑู ุนูุฏ ูุชุญ ุงููุงููุฑุง
- โ ูุง ูููู ุชุตููุฑ ุงูุทุนุงู ูู ุญุงุณุจุฉ ุงูุณุนุฑุงุช
- โ ูุง ูููู ุฑูุน ุตูุฑ ุงูููู ุงูุดุฎุตู

---

### 3๏ธโฃ **Firebase Bundle ID Warning** โ๏ธ
```
The project's Bundle ID is inconsistent with either the Bundle ID in 
'GoogleService-Info.plist'
```

**ุงูุณุจุจ:**
- Bundle ID ูู ุงููุดุฑูุน: `com.example.aldlma`
- Bundle ID ูู Firebase: `com.dalma.app`

**ุงูุชุฃุซูุฑ:**
- โ๏ธ ุชุญุฐูุฑ ููุท (ููุณ ุฎุทุฃ)
- Push Notifications ูุฏ ูุง ุชุนูู ุจุดูู ุตุญูุญ

---

## โ **ุงูุญููู ุงูููููุฐุฉ:**

### **1๏ธโฃ ุฅุตูุงุญ Database Connection Pool**

#### **ุงูุชุญุณููุงุช:**

```javascript
// dalma-api/index.js

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000, // โ ุฒูุงุฏุฉ ูู 2000 ุฅูู 5000
  keepAlive: true,                // โ ุฌุฏูุฏ
  keepAliveInitialDelayMillis: 10000, // โ ุฌุฏูุฏ
});
```

#### **ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ:**

```javascript
// ุชุณุฌูู ุฃุฎุทุงุก ุงูุงุชุตุงู
pool.on('error', (err, client) => {
  console.error('โ [POOL] ุฎุทุฃ ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช:', err);
  console.log('๐ [POOL] ุณูุชู ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุชููุงุฆูุงู...');
});

// ุชุฃููุฏ ุงูุงุชุตุงู ุงููุงุฌุญ
pool.on('connect', () => {
  console.log('โ [POOL] ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ');
});

// ุชุชุจุน ุฅุฒุงูุฉ ุงูุงุชุตุงูุงุช
pool.on('remove', () => {
  console.log('โ๏ธ [POOL] ุชู ุฅุฒุงูุฉ ุงุชุตุงู ูู Pool');
});
```

#### **Retry Logic:**

```javascript
async function queryWithRetry(queryText, params = [], retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await pool.query(queryText, params);
    } catch (error) {
      console.log(`โ๏ธ [QUERY RETRY] ูุญุงููุฉ ${i + 1}/${retries} ูุดูุช:`, error.message);
      
      // ุฅุฐุง ูุงู ุงูุฎุทุฃ ูุชุนูู ุจุงูุงุชุตุงู
      if (error.message.includes('Connection terminated') || 
          error.message.includes('Connection lost') ||
          error.message.includes('ECONNREFUSED')) {
        
        if (i < retries - 1) {
          // Exponential backoff: 1s, 2s, 4s (max 5s)
          const delay = Math.min(1000 * Math.pow(2, i), 5000);
          console.log(`๐ [QUERY RETRY] ุงูุงูุชุธุงุฑ ${delay}ms ูุจู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }
      }
      
      throw error;
    }
  }
}
```

#### **ุงููุชุงุฆุฌ:**

โ **ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุงูุชููุงุฆูุฉ** ุนูุฏ ุงููุทุงุน ุงูุงุชุตุงู  
โ **3 ูุญุงููุงุช** ููู ุงุณุชุนูุงู ูุจู ุงููุดู  
โ **Exponential Backoff** ูุชุฌูุจ ุฅุบุฑุงู ุงูุณูุฑูุฑ  
โ **Keep-Alive** ููุญูุงุธ ุนูู ุงูุงุชุตุงูุงุช ูุดุทุฉ  
โ **Logging ููุตู** ูุชุชุจุน ูุดุงูู ุงูุงุชุตุงู  

---

### **2๏ธโฃ ุฅุตูุงุญ Camera Permissions**

#### **ุงูุชุนุฏููุงุช:**

ุชู ุฅุถุงูุฉ ุฌููุน ุงูุตูุงุญูุงุช ุงููุทููุจุฉ ูู `ios/Runner/Info.plist`:

```xml
<!-- ุงููุงููุฑุง -->
<key>NSCameraUsageDescription</key>
<string>ูุญุชุงุฌ ุงููุตูู ูููุงููุฑุง ูุงูุชูุงุท ุงูุตูุฑ ูุชุญููู ุงูุทุนุงู ูุฑูุน ุงูุตูุฑ ุงูุดุฎุตูุฉ ูู ุชุทุจูู ุฏููุง</string>

<!-- ููุชุจุฉ ุงูุตูุฑ (ูุฑุงุกุฉ) -->
<key>NSPhotoLibraryUsageDescription</key>
<string>ูุญุชุงุฌ ุงููุตูู ูููุชุจุฉ ุงูุตูุฑ ูุฑูุน ุงูุตูุฑ ูู ุชุทุจูู ุฏููุง</string>

<!-- ููุชุจุฉ ุงูุตูุฑ (ูุชุงุจุฉ) -->
<key>NSPhotoLibraryAddUsageDescription</key>
<string>ูุญุชุงุฌ ุญูุธ ุงูุตูุฑ ูู ููุชุจุฉ ุงูุตูุฑ ูู ุชุทุจูู ุฏููุง</string>

<!-- ุงููููุฑูููู (ููููุฏูู) -->
<key>NSMicrophoneUsageDescription</key>
<string>ูุญุชุงุฌ ุงููุตูู ูููููุฑูููู ูุชุณุฌูู ููุงุทุน ุงูููุฏูู ูู ุชุทุจูู ุฏููุง</string>
```

#### **ุงููุชุงุฆุฌ:**

โ **ุงููุงููุฑุง ุชุนูู** ุจุฏูู crash  
โ **ุงุฎุชูุงุฑ ุงูุตูุฑ** ูู ุงูููุชุจุฉ ูุนูู  
โ **ุญูุธ ุงูุตูุฑ** ูุนูู  
โ **ุชุณุฌูู ุงูููุฏูู** ูุนูู  
โ **ุฑุณุงุฆู ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ** ูููุณุชุฎุฏู  

#### **ุงูุงุณุชุฎุฏุงูุงุช:**

- ๐ฝ๏ธ **ุญุงุณุจุฉ ุงูุณุนุฑุงุช**: ุชุตููุฑ ุงูุทุนุงู ููุชุญููู
- ๐ค **ุงูููู ุงูุดุฎุตู**: ุฑูุน ุตูุฑุฉ ุงูููู ุงูุดุฎุตู
- ๐ **ุทูุจุงุช ุงูุฅุนูุงูู**: ุฑูุน ุตูุฑุฉ ุงููููุฉ
- ๐ธ **ููุดูุฑุงุช ุงูุฅุนูุงูู**: ุฑูุน ุตูุฑ ูููุฏูู

---

## ๐ **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**

### **1๏ธโฃ Backend (dalma-api):**

- โ ุชู ุฑูุน ุงูุชุญุฏูุซุงุช ุนูู GitHub
- ๐ Render ุณููุนูุฏ Deploy ุชููุงุฆูุงู (2-3 ุฏูุงุฆู)
- ๐ ุฑุงูุจ Logs ูู Render Dashboard ููุชุฃูุฏ ูู ูุฌุงุญ Deploy

**ููู ุชุชุญูู:**

```
Render Dashboard โ dalma-api โ Logs

ุณุชุธูุฑ:
โ [POOL] ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ
โ [FCM] Firebase Admin SDK initialized successfully
๐ Server Heartbeat - All Systems Operational
```

---

### **2๏ธโฃ Flutter (aldlma):**

- โ ุชู ุฅุถุงูุฉ Camera Permissions
- ๐ ุฃุนุฏ ุจูุงุก ุงูุชุทุจูู ุนูู ุฌูุงุฒู

**ููู ุชุฎุชุจุฑ:**

```bash
# ุชููู ุนู ุงูุชุทุจูู ุงูุญุงูู (โ + .)

# ุฃุนุฏ ุงูุจูุงุก ูุงูุชุดุบูู
cd /Users/kimaalanzi/Desktop/aaldma/aldlma
flutter run
```

**ุฃู ูู Xcode:**
1. Clean Build Folder (โ + Shift + K)
2. Build (โ + B)
3. Run (โ + R)

---

### **3๏ธโฃ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช:**

#### **ุงุฎุชุจุงุฑ Database:**

1. ุงูุชุญ ุงูุชุทุจูู
2. ุฌุฑูุจ ุชุณุฌูู ุงูุฏุฎูู
3. ุชุญูู ูู ุงูู Logs:

```
โ ูุฌุจ ุฃู ูุธูุฑ:
๐ [AUTH] ุจุฏุก ุนูููุฉ ุชุณุฌูู ุงูุฏุฎูู
โ [AUTH] ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ

โ ูุง ูุฌุจ ุฃู ูุธูุฑ:
Error: Connection terminated unexpectedly
ุฎุทุฃ ุฏุงุฎูู ูู ุงูุฎุงุฏู
```

#### **ุงุฎุชุจุงุฑ Camera:**

1. ุงุฐูุจ ุฅูู "ุฃุฏูุงุช ุงูุฏููุง" โ "ุญุงุณุจุฉ ุงูุณุนุฑุงุช"
2. ุงุถุบุท ุนูู ุฃููููุฉ ุงููุงููุฑุง ๐ธ
3. iOS ุณูุทูุจ ุงูุฅุฐู (ุงุถุบุท "ุงูุณูุงุญ")
4. ุงูุชูุท ุตูุฑุฉ ุทุนุงู

```
โ ูุฌุจ ุฃู ูุนูู ุจุฏูู crash
โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุตูุฑุฉ
โ ูุฌุจ ุฃู ูุจุฏุฃ ุงูุชุญููู
```

---

## ๐ **ุงููููุงุช ุงูููุนุฏููุฉ:**

| ุงูููู | ุงูุชุนุฏูู |
|------|---------|
| `dalma-api/index.js` | Database Pool + Retry Logic |
| `aldlma/ios/Runner/Info.plist` | Camera & Photo Permissions |

---

## ๐ **ูุฑุงูุจุฉ ุงูุฃุฏุงุก:**

### **Render Logs:**

ุฑุงูุจ ูุฐู ุงูุฑุณุงุฆู ูู Render:

#### **โ ุฑุณุงุฆู ุฌูุฏุฉ:**
```
โ [POOL] ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ
๐ [AUTH] ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ
๐ Server Heartbeat - All Systems Operational
```

#### **โ๏ธ ุฑุณุงุฆู ุชุญุชุงุฌ ุงูุชุจุงู:**
```
โ๏ธ [QUERY RETRY] ูุญุงููุฉ 1/3 ูุดูุช
๐ [QUERY RETRY] ุงูุงูุชุธุงุฑ 1000ms ูุจู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
โ [POOL] ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ
```
*(ูุฐุง ุทุจูุนู - ุงููุธุงู ูุนูุฏ ุงููุญุงููุฉ ุชููุงุฆูุงู)*

#### **โ ุฑุณุงุฆู ูุดุงูู:**
```
โ [POOL] ุฎุทุฃ ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ [QUERY RETRY] ูุญุงููุฉ 3/3 ูุดูุช
Error: Connection terminated unexpectedly
```
*(ุฅุฐุง ุธูุฑุช ุจุดูู ูุชูุฑุฑุ ุชุญูู ูู Render Database)*

---

## ๐ฏ **ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:**

### **ูุจู ุงูุฅุตูุงุญ:**
- โ Database Connection ูููุทุน โ ูุดู ุชุณุฌูู ุงูุฏุฎูู
- โ Camera Permission ููููุฏ โ Crash ููุฑู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### **ุจุนุฏ ุงูุฅุตูุงุญ:**
- โ Database Connection ูุณุชูุฑ + ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ
- โ Camera & Photo Permissions ูุงููุฉ
- โ Retry Logic ุฐููุฉ
- โ Logging ููุตู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ

---

## ๐ง **ุงุณุชุฎุฏุงู Retry Logic ูู Endpoints:**

ุฅุฐุง ุฃุฑุฏุช ุงุณุชุฎุฏุงู `queryWithRetry()` ูู endpoint ูุนูู:

**ูุจู:**
```javascript
const result = await pool.query('SELECT * FROM users WHERE id = $1', [userId]);
```

**ุจุนุฏ:**
```javascript
const result = await queryWithRetry('SELECT * FROM users WHERE id = $1', [userId]);
```

**ุงููุงุฆุฏุฉ:**
- 3 ูุญุงููุงุช ุชููุงุฆูุฉ
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุงุชุตุงู
- ูุง ุญุงุฌุฉ ูู try/catch ุฅุถุงููุฉ

---

## ๐ **ูู ุญุงู ุงุณุชูุฑุงุฑ ุงููุดุงูู:**

### **Database Connection:**
1. ุชุญูู ูู Render Database status
2. ุชุญูู ูู `DATABASE_URL` ูู Environment Variables
3. ุฑุงุฌุน Render Logs ููุฃุฎุทุงุก
4. ุชุญูู ูู Render Dashboard โ Database โ Metrics

### **Camera Permission:**
1. ุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุจูุงุก ุงูุชุทุจูู ุจุนุฏ ุงูุชุนุฏููุงุช
2. ุงุญุฐู ุงูุชุทุจูู ูุฃุนุฏ ุชุซุจูุชู
3. ุชุญูู ูู Settings โ Privacy โ Camera โ Aldlma
4. ุชุฃูุฏ ูู ุฃู ุงูุฌูุงุฒ ุญูููู (ููุณ Simulator)

---

**๐ ุงูุขู ุงูุชุทุจูู ูุฌุจ ุฃู ูุนูู ุจุดูู ูุซุงูู!**

ุฌุฑูุจ:
1. ุชุณุฌูู ุงูุฏุฎูู โ
2. ูุชุญ ุญุงุณุจุฉ ุงูุณุนุฑุงุช โ
3. ุชุตููุฑ ุทุนุงู โ
4. ุฑูุน ุงูุตูุฑ โ

