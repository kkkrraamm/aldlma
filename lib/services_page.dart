import 'package:flutter/material.dart';
import 'dart:async';
import 'dart:convert';
import 'package:google_fonts/google_fonts.dart';
import 'package:http/http.dart' as http;
import 'unified_provider_profile.dart';
import 'desert_transition.dart';
import 'login_page.dart';
import 'auth.dart';
import 'notifications.dart';
import 'orders_service.dart';
import 'orders_page.dart';
import 'theme_config.dart';
// ุณูุณุชุฎุฏู ูุณุฎุฉ ูุญููุฉ ูู ุงูููุฏุฑ ุงููุทุงุจู ุงูููุฌูุฏ ูู ุงูุฑุฆูุณูุฉ/ุงูุชุฑูุฏุงุช

class ServicesPage extends StatefulWidget {
  final bool showAppBar;
  
  const ServicesPage({Key? key, this.showAppBar = true}) : super(key: key);
  
  @override
  _ServicesPageState createState() => _ServicesPageState();
}

class _ServicesPageState extends State<ServicesPage> {
  String _selectedCategory = "all";
  String _searchQuery = "";
  bool _showSearchInput = false;
  PageController? _adsController;
  Timer? _adsTimer;
  int _adsIndex = 0;

  // ุงููุฆุงุช ุงููุชุงุญุฉ
  List<Map<String, dynamic>> categories = [
    {"id": "all", "name": "ุงููู", "icon": "๐"},
  ];
  bool _loadingCategories = true;

  @override
  void initState() {
    super.initState();
    _loadCategories();
    _adsController = PageController(viewportFraction: 0.95);
    _adsTimer = Timer.periodic(const Duration(seconds: 4), (_) {
      if (!mounted || _adsController == null) return;
      final next = (_adsIndex + 1) % 3;
      _adsController!.animateToPage(
        next,
        duration: const Duration(milliseconds: 450),
        curve: Curves.easeOut,
      );
      setState(() => _adsIndex = next);
    });
  }
  
  Future<void> _loadCategories() async {
    try {
      print('๐๏ธ [CATEGORIES] Loading from API...');
      final response = await http.get(
        Uri.parse('https://dalma-api.onrender.com/api/categories'),
      );
      
      if (response.statusCode == 200) {
        final List<dynamic> data = jsonDecode(response.body);
        setState(() {
          categories = [
            {"id": "all", "name": "ุงููู", "icon": "๐"},
            ...data.map((cat) => {
              "id": cat['name'],
              "name": cat['name'],
              "icon": cat['icon_emoji'] ?? '๐',
            }).toList(),
          ];
          _loadingCategories = false;
        });
        print('โ [CATEGORIES] Loaded ${categories.length} categories');
      } else {
        setState(() => _loadingCategories = false);
      }
    } catch (e) {
      print('โ [CATEGORIES] Error: $e');
      setState(() => _loadingCategories = false);
    }
  }

  @override
  void dispose() {
    _adsTimer?.cancel();
    _adsController?.dispose();
    super.dispose();
  }

  // ููุฏูู ุงูุฎุฏูุงุช (ุจูุงูุงุช ุชุฌุฑูุจูุฉ)
  final List<Map<String, dynamic>> providers = [
    {
      "id": 1,
      "name": "ูุทุนู ุงูุฏููุง ุงูุชุฑุงุซู",
      "description": "ุฃุทุจุงู ุณุนูุฏูุฉ ุชุฑุงุซูุฉ ุฃุตููุฉ ุจูููุงุช ุนุฑุจูุฉ ุนุฑููุฉ",
      "category": "ูุทุงุนู",
      "address": "ุญู ุงููุฒูุฉุ ุดุงุฑุน ุงูููู ููุฏุ ุนุฑุนุฑ",
      "phone": "+966501234567",
      "rating": "4.8",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 2,
      "name": "ูุฑุดุฉ ุงููุงูุฑ ููุตูุงูุฉ",
      "description": "ุตูุงูุฉ ุฌููุน ุฃููุงุน ุงูุฃุฌูุฒุฉ ุงูููุฑุจุงุฆูุฉ ูุงูุฅููุชุฑูููุฉ",
      "category": "ุตูุงูุฉ",
      "address": "ุญู ุงูุตูุงุนูุฉุ ุดุงุฑุน ุงูุฃููุฑ ุนุจุฏุงูููุ ุนุฑุนุฑ",
      "phone": "+966502345678",
      "rating": "4.7",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 3,
      "name": "ุงููุธุงูุฉ ุงูุดุงููุฉ",
      "description": "ุฎุฏูุงุช ุชูุธูู ุงูููุงุฒู ูุงูููุงุชุจ ูุงูููู ุจุฃุญุฏุซ ุงููุนุฏุงุช",
      "category": "ุชูุธูู",
      "address": "ุญู ุงูุณูุงูุ ุดุงุฑุน ุงูุชุญููุฉุ ุนุฑุนุฑ",
      "phone": "+966503456789",
      "rating": "4.9",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 4,
      "name": "ุตุงููู ุงูุฃูุงูุฉ ููุณูุฏุงุช",
      "description": "ุฎุฏูุงุช ุชุฌููู ุดุงููุฉ ููุณูุฏุงุช ูุน ุฃุญุฏุซ ุตูุญุงุช ุงูููุถุฉ",
      "category": "ุชุฌููู",
      "address": "ุญู ุงูุฑูุถุฉุ ุดุงุฑุน ุงูุฃููุฑุงุชุ ุนุฑุนุฑ",
      "phone": "+966504567890",
      "rating": "4.6",
      "isOpen": false,
      "status": "approved"
    },
    {
      "id": 5,
      "name": "ุดุฑูุฉ ุงูููู ุงูุณุฑูุน",
      "description": "ุฎุฏูุงุช ููู ุงูุจุถุงุฆุน ูุงูุฃุซุงุซ ุฏุงุฎู ูุฎุงุฑุฌ ูุฏููุฉ ุนุฑุนุฑ",
      "category": "ููู",
      "address": "ุญู ุงููุฑูุฏุ ุดุงุฑุน ุงูููู ุณุนูุฏุ ุนุฑุนุฑ",
      "phone": "+966505678901",
      "rating": "4.5",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 6,
      "name": "ุนูุงุฏุฉ ุงูุฏูุชูุฑ ุฃุญูุฏ ููุฃุณูุงู",
      "description": "ุนูุงุฌ ูุชุฌููู ุงูุฃุณูุงู ุจุฃุญุฏุซ ุงูุชูููุงุช ุงูุทุจูุฉ",
      "category": "ุตุญุฉ",
      "address": "ุญู ุงููุทุงุฑุ ุดุงุฑุน ุงูููู ุฎุงูุฏุ ุนุฑุนุฑ",
      "phone": "+966506789012",
      "rating": "4.9",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 7,
      "name": "ุฃูุงุฏูููุฉ ุงูุชููู ุงูุชุนููููุฉ",
      "description": "ุฏุฑูุณ ุชูููุฉ ูู ุฌููุน ุงูููุงุฏ ูููุฑุงุญู ุงูุฏุฑุงุณูุฉ ุงููุฎุชููุฉ",
      "category": "ุชุนููู",
      "address": "ุญู ุงูุฌุงูุนุฉุ ุดุงุฑุน ุงูุชุนูููุ ุนุฑุนุฑ",
      "phone": "+966507890123",
      "rating": "4.7",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 8,
      "name": "ุณูู ุงูุฏููุง ุงููุฑูุฒู",
      "description": "ูุชุฌุฑ ุดุงูู ูุฌููุน ุงุญุชูุงุฌุงุช ุงูููุฒู ูุงูุฃุณุฑุฉ ูุน ุชูุตูู ุนุจุฑ ุชุทุจููุงุช ูุชุนุฏุฏุฉ",
      "category": "ุชุณูู",
      "address": "ูุณุท ุงููุฏููุฉุ ุดุงุฑุน ุงูุชุฌุงุฑุฉุ ุนุฑุนุฑ",
      "phone": "+966508901234",
      "rating": "4.4",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 2,
      "name": "ุณุจุงู ุงูุฎุจุฑุฉ ุงููุญุชุฑู",
      "description": "ุฎุฏูุงุช ุงูุณุจุงูุฉ ุงููุชูุงููุฉ ูุฅุตูุงุญ ุฌููุน ุงูุฃุนุทุงู ุจุถูุงู ุดุงูู",
      "category": "ุฎุฏูุงุช ููุฒููุฉ",
      "address": "ุญู ุงูุตูุงุนูุฉุ ุดุงุฑุน ุงูุชุฎุตุตูุ ุนุฑุนุฑ",
      "phone": "+966502345678",
      "rating": "4.9",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 3,
      "name": "ูุฌุงุฑุฉ ุงูุฅุชูุงู ูุงูุฌูุฏุฉ",
      "description": "ุฃุนูุงู ุงููุฌุงุฑุฉ ูุงูุฏูููุฑ ุงูุฎุดุจู ุงููุชููุฒ ุจุฃุญุฏุซ ุงูุชูููุงุช",
      "category": "ุฎุฏูุงุช ููุฒููุฉ",
      "address": "ุญู ุงูููุฒุ ุดุงุฑุน ุงูุฃููุฑ ุณูุทุงูุ ุนุฑุนุฑ",
      "phone": "+966503456789",
      "rating": "4.7",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 4,
      "name": "ุจุณุชุงู ุงููุฑูุฏ ุงูุทุจูุนูุฉ",
      "description": "ุฃุฌูู ุงููุฑูุฏ ูุงููุจุงุชุงุช ุงูุทุจูุนูุฉ ูุฌููุน ุงูููุงุณุจุงุช ูุน ุงูุชูุณูู ุงูุงุญุชุฑุงูู",
      "category": "ูุฏุงูุง ููุฑูุฏ",
      "address": "ุญู ุงูุฑูุถุฉุ ุดุงุฑุน ุงูุนููุงุ ุนุฑุนุฑ",
      "phone": "+966504567890",
      "rating": "4.6",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 5,
      "name": "ุนุงูู ุงููุฏุงูุง ุงููููุฒุฉ",
      "description": "ูุฏุงูุง ูููุฒุฉ ููุฑูุฏุฉ ูุฌููุน ุงูููุงุณุจุงุช ูุงูุฃุนูุงุฑ ูุน ุงูุชุบููู ุงููุงุฎุฑ",
      "category": "ูุฏุงูุง ููุฑูุฏ",
      "address": "ุญู ุงููุทุงุฑุ ุดุงุฑุน ุงูููู ุฎุงูุฏุ ุนุฑุนุฑ",
      "phone": "+966505678901",
      "rating": "4.5",
      "isOpen": true,
      "status": "approved"
    },
    {
      "id": 6,
      "name": "ููููุฉ ุงูุฃูุนุงุจ ุงูุชุนููููุฉ",
      "description": "ุฃูุนุงุจ ุชุนููููุฉ ูุชุฑููููุฉ ุขููุฉ ูุฌููุน ุงูุฃุนูุงุฑ ูุน ุงุณุชุดุงุฑุงุช ุชุฑุจููุฉ",
      "category": "ุฃูุนุงุจ ูุชุฑููู",
      "address": "ุญู ุงูุดูุงุกุ ุดุงุฑุน ุงูุฃูุฏูุณุ ุนุฑุนุฑ",
      "phone": "+966506789012",
      "rating": "4.4",
      "isOpen": true,
      "status": "approved"
    },
  ];

  // ููุชุฑุฉ ุงูููุฏููู
  List<Map<String, dynamic>> get filteredProviders {
    return providers.where((provider) {
      final matchesCategory = _selectedCategory == "all" || provider['category'] == _selectedCategory;
      final matchesSearch = _searchQuery.isEmpty ||
          provider['name'].toLowerCase().contains(_searchQuery.toLowerCase()) ||
          provider['category'].toLowerCase().contains(_searchQuery.toLowerCase()) ||
          (provider['description']?.toLowerCase().contains(_searchQuery.toLowerCase()) ?? false);
      return matchesCategory && matchesSearch;
    }).toList();
  }

  Widget _buildServicesHeader() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      child: Row(
        children: [
          Expanded(
            child: Text(
              'ุงูุชุดู ุฎุฏูุงุช ุงูุฏููุง',
              style: GoogleFonts.cairo(fontSize: 18, fontWeight: FontWeight.w800, color: const Color(0xFF10B981)),
            ),
          ),
          ElevatedButton.icon(
            onPressed: () => setState(() => _showSearchInput = !_showSearchInput),
            icon: const Icon(Icons.search, size: 18),
            label: Text('ุจุญุซ', style: GoogleFonts.cairo()),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF10B981),
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
          )
        ],
      ),
    );
  }

  Widget _buildAdsCarousel() {
    final List<String> banners = [
      'assets/img/aldlma.png',
      'assets/img/al5dmat.png',
      'assets/img/al5re6h.png',
    ];
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Column(
        children: [
          SizedBox(
            height: 160,
            child: PageView.builder(
              controller: _adsController,
              itemCount: banners.length,
              onPageChanged: (i) => setState(() => _adsIndex = i),
              itemBuilder: (context, index) {
                return Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(16),
                    child: Stack(
                      fit: StackFit.expand,
                      children: [
                        Image.asset(banners[index], fit: BoxFit.cover),
                        Container(
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              begin: Alignment.bottomCenter,
                              end: Alignment.topCenter,
                              colors: [Colors.black.withOpacity(0.35), Colors.transparent],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            ),
          ),
          const SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: List.generate(banners.length, (i) => Container(
              width: 8,
              height: 8,
              margin: const EdgeInsets.symmetric(horizontal: 3),
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: i == _adsIndex ? const Color(0xFF10B981) : Colors.grey.shade300,
              ),
            )),
          ),
        ],
      ),
    );
  }
  // ุฃููููุฉ ุงููุฆุฉ
  String _getCategoryIcon(String category) {
    switch (category) {
      case "ูุทุงุนู": return "๐ฝ๏ธ";
      case "ุฎุฏูุงุช ููุฒููุฉ": return "๐ง";
      case "ูุฏุงูุง ููุฑูุฏ": return "๐";
      case "ุฃูุนุงุจ ูุชุฑููู": return "๐งธ";
      case "ุตูุงูุฉ": return "๐ง";
      case "ุชูุธูู": return "๐งฝ";
      case "ุชุฌููู": return "๐";
      case "ููู": return "๐";
      case "ุตุญุฉ": return "๐ฅ";
      case "ุชุนููู": return "๐";
      case "ุชุณูู": return "๐๏ธ";
      default: return "๐ข";
    }
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: ThemeConfig.instance,
      builder: (context, _) {
        final theme = ThemeConfig.instance;
        final isDark = theme.isDarkMode;
        
        return Scaffold(
          backgroundColor: theme.backgroundColor,
          body: CustomScrollView(
        slivers: [
          // ููุณ ููุฏุฑ ุงูุฑุฆูุณูุฉ/ุงูุชุฑูุฏุงุช (ูุณุฎุฉ ูุญููุฉ)
          SliverToBoxAdapter(child: _HeroHeader()),
          
          // ุฒุฑ ูููุชุฑ ูุจุญุซ
          SliverToBoxAdapter(child: _buildServicesHeader()),
          SliverToBoxAdapter(child: _showSearchInput ? _buildSearchInput() : const SizedBox.shrink()),
          SliverToBoxAdapter(child: _buildCategoriesFilter()),

          // ุจุงูุฑ ูุงุญุฏ ุจุงูุนุฑุถ ูุฏูุฑ ุชููุงุฆูุงู
          SliverToBoxAdapter(child: _buildAdsCarousel()),

          // ูุณู ุทูุจุงุชู (ูุฏูุฌ)
          SliverToBoxAdapter(child: _buildMyOrdersSection()),

          // ูุงุฆูุฉ ููุฏูู ุงูุฎุฏูุงุช
          SliverToBoxAdapter(child: _buildProvidersList()),
        ],
      ),
        );
      },
    );
  }

  Widget _buildMyOrdersSection() {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return AnimatedBuilder(
      animation: Listenable.merge([AuthState.instance, OrdersService.instance, theme]),
      builder: (context, _) {
        if (!AuthState.instance.isLoggedIn) return const SizedBox.shrink();
        final phone = AuthState.instance.phone;
        if (phone == null || phone.isEmpty) return const SizedBox.shrink();
        final orders = OrdersService.instance.getOrdersForPhone(phone);
        final hasOrders = orders.isNotEmpty;
        final last = hasOrders ? orders.last : null;

        return Container(
          color: Colors.transparent, // ุฎูููุฉ ุดูุงูุฉ ูุฅุธูุงุฑ ุงูุจูุฌ
          padding: const EdgeInsets.symmetric(vertical: 16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: Row(
                  children: [
                    Expanded(
                      child: Text(
                        'ุทูุจุงุชู',
                        style: GoogleFonts.cairo(
                          fontSize: 16,
                          fontWeight: FontWeight.w800,
                          color: isDark ? ThemeConfig.kGoldNight : Color(0xFF10B981),
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                  ],
                ),
              ),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: hasOrders
                    ? _LastOrderCard(order: last!)
                    : Container(
                        width: double.infinity,
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: isDark ? ThemeConfig.kNightAccent : Colors.grey.shade50,
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: theme.borderColor),
                        ),
                        child: Center(
                          child: Text(
                            'ูุง ุชูุฌุฏ ุทูุจุงุช',
                            style: GoogleFonts.cairo(
                              fontSize: 14,
                              color: theme.textSecondaryColor,
                              fontWeight: FontWeight.w700,
                            ),
                          ),
                        ),
                      ),
              ),

              const SizedBox(height: 8),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (_) => const OrdersPage(showAppBar: true, showBottomNav: true)),
                      );
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: isDark ? ThemeConfig.kGoldNight : Color(0xFF10B981),
                      foregroundColor: isDark ? ThemeConfig.kNightDeep : Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                    icon: const Icon(Icons.receipt_long_outlined, size: 18),
                    label: Text('ุทูุจุงุชู', style: GoogleFonts.cairo(fontWeight: FontWeight.w800)),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildAppBar() {
    return Container(
      padding: EdgeInsets.only(
        top: MediaQuery.of(context).padding.top + 10,
        bottom: 15,
        left: 20,
        right: 20,
      ),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            Color(0xFFFEF3E2),
            Color(0xFFECFDF5),
            Color(0xFFFEF3E2),
          ],
          stops: [0.0, 0.5, 1.0],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
      ),
      child: Row(
        children: [
          IconButton(
            icon: Icon(Icons.arrow_back_ios, color: Colors.black87),
            onPressed: () => Navigator.pop(context),
          ),
          Expanded(
            child: Text(
              'ุฎุฏูุงุช ุงูุฏููุง',
              textAlign: TextAlign.center,
              style: GoogleFonts.cairo(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: Colors.black87,
              ),
            ),
          ),
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.5),
              borderRadius: BorderRadius.circular(12),
            ),
            child: IconButton(
              icon: Icon(
                _showSearchInput ? Icons.close : Icons.search,
                color: Color(0xFF10B981),
                size: 20,
              ),
              onPressed: () {
                setState(() {
                  _showSearchInput = !_showSearchInput;
                  if (!_showSearchInput) _searchQuery = "";
                });
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSimpleHeader() {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.only(
        top: MediaQuery.of(context).padding.top + 10,
        bottom: 20,
        left: 20,
        right: 20,
      ),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            Color(0xFFFEF3E2),
            Color(0xFFECFDF5),
            Color(0xFFFEF3E2),
          ],
          stops: [0.0, 0.5, 1.0],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
      ),
      child: Column(
        children: [
          // ุชููุฌ ุฎูู ุงูุดุนุงุฑ
          Stack(
            alignment: Alignment.center,
            children: [
              Container(
                width: 100,
                height: 100,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: RadialGradient(
                    colors: [
                      Color(0xFF4F46E5).withOpacity(0.15),
                      Colors.transparent,
                    ],
                    stops: [0.0, 1.0],
                  ),
                ),
              ),
              Container(
                width: 80,
                height: 80,
                padding: EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: Colors.white,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 10,
                      spreadRadius: 2,
                    ),
                  ],
                ),
                child: Icon(
                  Icons.home_repair_service,
                  color: Color(0xFF10B981),
                  size: 40,
                ),
              ),
            ],
          ),
          SizedBox(height: 12),
          Text(
            'ุฎุฏูุงุช ุงูุฏููุง',
            style: GoogleFonts.cairo(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: Colors.black87,
            ),
          ),
          SizedBox(height: 4),
          Text(
            'ุงูุชุดู ุฌููุน ุงูุฎุฏูุงุช ุงููุชุงุญุฉ ูู ุนุฑุนุฑ',
            style: GoogleFonts.cairo(
              fontSize: 14,
              color: Colors.black54,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSearchInput() {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return Container(
      color: theme.cardColor,
      padding: EdgeInsets.all(16),
      child: Container(
        decoration: BoxDecoration(
          color: isDark ? ThemeConfig.kNightAccent : Colors.grey.shade50,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: theme.borderColor),
        ),
        child: TextField(
          textAlign: TextAlign.right,
          style: TextStyle(color: theme.textPrimaryColor),
          decoration: InputDecoration(
            hintText: 'ุงุจุญุซ ุนู ุฎุฏูุฉ...',
            hintStyle: GoogleFonts.cairo(color: theme.textSecondaryColor),
            prefixIcon: Icon(Icons.search, color: theme.textSecondaryColor),
            border: InputBorder.none,
            contentPadding: EdgeInsets.all(16),
          ),
          onChanged: (value) {
            setState(() {
              _searchQuery = value;
            });
          },
        ),
      ),
    );
  }

  Widget _buildCategoriesFilter() {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return Container(
      color: Colors.transparent, // ุฎูููุฉ ุดูุงูุฉ ูุฅุธูุงุฑ ุงูุจูุฌ
      padding: EdgeInsets.symmetric(vertical: 16),
      child: SizedBox(
        height: 50,
        child: ListView.builder(
          scrollDirection: Axis.horizontal,
          padding: EdgeInsets.symmetric(horizontal: 16),
          itemCount: categories.length,
          itemBuilder: (context, index) {
            final category = categories[index];
            final isSelected = _selectedCategory == category['id'];
            
            return Container(
              margin: EdgeInsets.only(left: 8),
              child: FilterChip(
                selected: isSelected,
                label: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      category['icon'],
                      style: TextStyle(fontSize: 16),
                    ),
                    SizedBox(width: 6),
                    Text(
                      category['name'],
                      style: GoogleFonts.cairo(
                        fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                        color: isSelected 
                          ? (isDark ? ThemeConfig.kNightDeep : Colors.white)
                          : theme.textPrimaryColor,
                      ),
                    ),
                  ],
                ),
                selectedColor: isDark ? ThemeConfig.kGoldNight : Color(0xFF10B981),
                backgroundColor: isDark ? ThemeConfig.kNightAccent : Colors.grey.shade100,
                onSelected: (selected) {
                  setState(() {
                    _selectedCategory = category['id'];
                  });
                },
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(25),
                ),
              ),
            );
          },
        ),
      ),
    );
  }

  Widget _buildProvidersList() {
    final filtered = filteredProviders;
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    if (filtered.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.search_off,
              size: 64,
              color: theme.textSecondaryColor,
            ),
            SizedBox(height: 16),
            Text(
              'ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุชุงุญุฉ',
              style: GoogleFonts.cairo(
                fontSize: 18,
                color: theme.textPrimaryColor,
              ),
            ),
            Text(
              'ุฌุฑุจ ุงูุจุญุซ ุจูููุงุช ูุฎุชููุฉ ุฃู ุงุฎุชุฑ ูุฆุฉ ุฃุฎุฑู',
              style: GoogleFonts.cairo(
                fontSize: 14,
                color: theme.textSecondaryColor,
              ),
            ),
          ],
        ),
      );
    }

    return ListView.builder(
      padding: const EdgeInsets.all(16),
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: filtered.length,
      itemBuilder: (context, index) {
        return _buildProviderCard(filtered[index]);
      },
    );
  }

  Widget _buildProviderCard(Map<String, dynamic> provider) {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return Card(
      margin: EdgeInsets.only(bottom: 16),
      elevation: 0,
      color: theme.cardColor,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(color: theme.borderColor, width: 1),
      ),
      child: InkWell(
        borderRadius: BorderRadius.circular(16),
        onTap: () {
          // ุงูุงูุชูุงู ูุตูุญุฉ ุงูุจุฑููุงูู ุงูููุญุฏุฉ ุงููุงุฎุฑุฉ
          Navigator.push(
            context,
            PageRouteBuilder(
              pageBuilder: (context, animation, secondaryAnimation) => 
                UnifiedProviderProfile(providerId: provider['id']),
              transitionDuration: const Duration(milliseconds: 800),
              transitionsBuilder: (context, animation, secondaryAnimation, child) {
                return DesertWindTransition(
                  animation: animation,
                  child: child,
                );
              },
            ),
          );
        },
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Row(
            children: [
              // ุฃููููุฉ ุงูุฎุฏูุฉ
              Container(
                width: 60,
                height: 60,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: isDark 
                      ? [ThemeConfig.kGoldNight, ThemeConfig.kGoldNight.withOpacity(0.7)]
                      : [Color(0xFF10B981), Color(0xFF059669)],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Center(
                  child: Text(
                    _getCategoryIcon(provider['category']),
                    style: TextStyle(fontSize: 28),
                  ),
                ),
              ),
              SizedBox(width: 16),
              
              // ูุนูููุงุช ุงูููุฏู
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // ุงูุงุณู ูุงูุชูููู
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Expanded(
                          child: Text(
                            provider['name'],
                            style: GoogleFonts.cairo(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: theme.textPrimaryColor,
                            ),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                        Row(
                          children: [
                            Icon(
                              Icons.star,
                              color: Colors.amber,
                              size: 16,
                            ),
                            SizedBox(width: 4),
                            Text(
                              provider['rating'],
                              style: GoogleFonts.cairo(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: theme.textPrimaryColor,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                    SizedBox(height: 4),
                    
                    // ุงููุตู
                    Text(
                      provider['description'],
                      style: GoogleFonts.cairo(
                        fontSize: 12,
                        color: theme.textSecondaryColor,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    SizedBox(height: 8),
                    
                    // ุงููุนูููุงุช ุงูุฅุถุงููุฉ
                    Row(
                      children: [
                        Icon(
                          Icons.location_on,
                          color: theme.textSecondaryColor,
                          size: 14,
                        ),
                        SizedBox(width: 4),
                        Expanded(
                          child: Text(
                            provider['address'],
                            style: GoogleFonts.cairo(
                              fontSize: 11,
                              color: theme.textSecondaryColor,
                            ),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 4),
                    
                    Row(
                      children: [
                        Icon(
                          Icons.phone,
                          color: theme.textSecondaryColor,
                          size: 14,
                        ),
                        SizedBox(width: 4),
                        Text(
                          provider['phone'],
                          style: GoogleFonts.cairo(
                            fontSize: 11,
                            color: theme.textSecondaryColor,
                          ),
                        ),
                        Spacer(),
                        Container(
                          padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                          decoration: BoxDecoration(
                            color: provider['isOpen'] 
                              ? (isDark ? Colors.green.shade900.withOpacity(0.3) : Colors.green.shade100)
                              : (isDark ? Colors.red.shade900.withOpacity(0.3) : Colors.red.shade100),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            provider['isOpen'] ? 'ููุชูุญ' : 'ูุบูู',
                            style: GoogleFonts.cairo(
                              fontSize: 10,
                              color: provider['isOpen'] 
                                ? (isDark ? Colors.green.shade300 : Colors.green.shade700)
                                : (isDark ? Colors.red.shade300 : Colors.red.shade700),
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 8),
                    
                    // ุงููุฆุฉ ูุณูู ุงูุชูุงุตูู
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Container(
                          padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: isDark ? ThemeConfig.kNightAccent : Colors.grey.shade200,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            provider['category'],
                            style: GoogleFonts.cairo(
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                              color: theme.textSecondaryColor,
                            ),
                          ),
                        ),
                        Icon(
                          Icons.arrow_forward_ios,
                          color: theme.textSecondaryColor,
                          size: 16,
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ูุณุฎุฉ ูุทุงุจูุฉ ูู ุงูููุฏุฑ ุงููุณุชุฎุฏู ูู ุงูุตูุญุงุช ุงูุฃุฎุฑู
class _HeroHeader extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final theme = ThemeConfig.instance;
    final color = Theme.of(context).colorScheme.primary;
    
    return AnimatedBuilder(
      animation: theme,
      builder: (context, child) {
        return Container(
          padding: const EdgeInsets.only(top: 12, bottom: 20),
          decoration: BoxDecoration(
            gradient: theme.headerGradient,
          ),
      child: Stack(
        alignment: Alignment.center,
        children: [
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                const SizedBox(height: 48),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: const [
                    _LoginButton(),
                    Row(
                      children: [
                        _ThemeToggleButton(),
                        SizedBox(width: 8),
                        NotificationsBell(),
                      ],
                    ),
                  ],
                ),
                const SizedBox(height: 32),
                Center(
                  child: Stack(
                    alignment: Alignment.center,
                    children: [
                      Container(
                        width: 350,
                        height: 350,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: RadialGradient(
                            colors: [
                              color.withOpacity(0.25),
                              color.withOpacity(0.15),
                              color.withOpacity(0.08),
                              color.withOpacity(0.03),
                              Colors.transparent,
                            ],
                            stops: const [0.0, 0.3, 0.5, 0.7, 1.0],
                          ),
                        ),
                      ),
                      Image.asset('assets/img/aldlma.png', width: 176, height: 176),
                    ],
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  'ุงูุฏููุง... ุฒุฑุนูุง ุทูุจุ ูุฎูุฑูุง ุจุงูู',
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 32,
                    fontWeight: FontWeight.w800,
                    color: Theme.of(context).colorScheme.secondary,
                    height: 1.2,
                  ),
                ),
                const SizedBox(height: 16),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8),
                  child: Text(
                    'ุงูุชุดู ุฎุฏูุงุช ูุฏููุชู ูู ุฃูููุงุ ูุน ุฃูุถู ุงูุชุฌุงุฑุจ.',
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: Theme.of(context).colorScheme.primary,
                      fontSize: 18,
                      height: 1.6,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
        );
      },
    );
  }
}

class _LoginButton extends StatelessWidget {
  const _LoginButton({super.key});
  @override
  Widget build(BuildContext context) {
    return InkWell(
      borderRadius: const BorderRadius.all(Radius.circular(6)),
      onTap: () {
        if (AuthState.instance.isLoggedIn) {
          AuthState.instance.logout();
          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ')));
        } else {
          Navigator.push(context, MaterialPageRoute(builder: (_) => const LoginPage()));
        }
      },
      child: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(colors: [Color(0xFFD97706), Color(0xFF059669)]),
          borderRadius: BorderRadius.all(Radius.circular(6)),
          boxShadow: [
            BoxShadow(color: Colors.black12, blurRadius: 8, offset: Offset(0, 2)),
          ],
        ),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
        child: AnimatedBuilder(
          animation: AuthState.instance,
          builder: (context, _) {
            final isIn = AuthState.instance.isLoggedIn;
            return Row(mainAxisSize: MainAxisSize.min, children: [
              Icon(isIn ? Icons.logout : Icons.person_outline, color: Colors.white, size: 16),
              const SizedBox(width: 8),
              Text(isIn ? 'ุชุณุฌูู ุงูุฎุฑูุฌ' : 'ุชุณุฌูู ุงูุฏุฎูู', 
                style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 14)),
            ]);
          },
        ),
      ),
    );
  }
}

class _ThemeToggleButton extends StatelessWidget {
  const _ThemeToggleButton();
  
  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: ThemeConfig.instance,
      builder: (context, child) {
        final theme = ThemeConfig.instance;
        final isDark = theme.isDarkMode;
        
        return GestureDetector(
          onTap: () async {
            await theme.toggleTheme();
          },
          child: Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: isDark ? ThemeConfig.kNightSoft : Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: theme.cardShadow,
            ),
            child: Center(
              child: Text(
                isDark ? 'โ๏ธ' : '๐',
                style: const TextStyle(fontSize: 20),
              ),
            ),
          ),
        );
      },
    );
  }
}

class _IconButton extends StatelessWidget {
  final IconData icon;
  const _IconButton({required this.icon});
  @override
  Widget build(BuildContext context) {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return Container(
      width: 40,
      height: 40,
      decoration: BoxDecoration(
        color: isDark ? ThemeConfig.kNightSoft : Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: theme.cardShadow,
      ),
      child: Center(child: Icon(icon, color: const Color(0xFF6B7280), size: 20)),
    );
  }
}

class _IconBadge extends StatelessWidget {
  final IconData icon;
  final String? count;
  final Color badgeColor;
  const _IconBadge({required this.icon, this.count, this.badgeColor = Colors.red});
  @override
  Widget build(BuildContext context) {
    return Container(
      width: 40,
      height: 40,
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(color: Colors.black.withOpacity(0.06), blurRadius: 8, offset: const Offset(0, 2)),
        ],
      ),
      child: Stack(clipBehavior: Clip.none, children: [
        const Center(child: Icon(Icons.notifications_none, color: Color(0xFF6B7280), size: 20)),
        if (count != null)
          Positioned(
            top: -4,
            left: -4,
            child: Container(
              width: 18,
              height: 18,
              decoration: BoxDecoration(
                color: badgeColor,
                borderRadius: BorderRadius.circular(9),
                border: Border.all(color: Colors.white, width: 2),
              ),
              child: Center(
                child: Text(count!, style: const TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.w700)),
              ),
            ),
          ),
      ]),
    );
  }
}

class _LastOrderCard extends StatelessWidget {
  final Map<String, dynamic> order;
  const _LastOrderCard({required this.order});
  @override
  Widget build(BuildContext context) {
    final theme = ThemeConfig.instance;
    final isDark = theme.isDarkMode;
    
    return Container(
      decoration: BoxDecoration(
        color: theme.cardColor,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: theme.borderColor),
        boxShadow: theme.cardShadow,
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        leading: Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            color: (isDark ? ThemeConfig.kGoldNight : Color(0xFF10B981)).withOpacity(0.1),
            borderRadius: BorderRadius.circular(10),
          ),
          child: Center(
            child: Text((order['icon'] ?? '๐๏ธ').toString(), style: const TextStyle(fontSize: 18)),
          ),
        ),
        title: Text(
          (order['service'] ?? 'ุฎุฏูุฉ').toString(),
          style: GoogleFonts.cairo(
            fontWeight: FontWeight.w700,
            fontSize: 14,
            color: theme.textPrimaryColor,
          ),
          overflow: TextOverflow.ellipsis,
        ),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const SizedBox(height: 2),
            Text(
              'ุทูุจ #${order['orderNumber'] ?? ''} โข ${(order['date'] ?? '')}',
              style: GoogleFonts.cairo(
                fontSize: 11,
                color: theme.textSecondaryColor,
              ),
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
            const SizedBox(height: 2),
            Text(
              (order['status'] ?? '').toString(),
              style: GoogleFonts.cairo(
                fontSize: 11,
                color: theme.textSecondaryColor,
              ),
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
          ],
        ),
        trailing: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              (order['totalDisplay'] ?? '').toString(),
              style: GoogleFonts.cairo(
                fontWeight: FontWeight.w800,
                color: isDark ? ThemeConfig.kGoldNight : Color(0xFF10B981),
                fontSize: 12,
              ),
            ),
            const SizedBox(height: 4),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
              decoration: BoxDecoration(
                color: isDark ? ThemeConfig.kNightAccent : Colors.grey.shade100,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(
                (order['deliveryMethod'] == 'pickup') ? 'ุงุณุชูุงู' : 'ุชูุตูู',
                style: GoogleFonts.cairo(
                  fontSize: 10,
                  color: theme.textSecondaryColor,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}